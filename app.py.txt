import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd
from datetime import datetime

# --- 1. í˜ì´ì§€ ì„¤ì • ë° í…Œë§ˆ ---
st.set_page_config(page_title="í•œí™”ì´ê¸€ìŠ¤ ë‹¨ê´€ íˆ¬í‘œ", layout="centered")

st.markdown("""
    <style>
    .stApp { background-color: #000000; color: #FFFFFF; }
    .stButton>button { background-color: #FF6600; color: white; border-radius: 8px; font-weight: bold; width: 100%; }
    .stHeader { color: #FF6600; }
    .stCheckbox { color: #FF6600; }
    div[data-testid="stMetricValue"] { color: #FF6600; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° ---
# ì‹¤ì œ ì‚¬ìš© ì‹œ SHEET_URLì— ë³¸ì¸ì˜ êµ¬ê¸€ ì‹œíŠ¸ ì£¼ì†Œë¥¼ ë„£ìœ¼ì„¸ìš”.
SHEET_URL = "ì—¬ê¸°ì—_ë³µì‚¬í•œ_êµ¬ê¸€ì‹œíŠ¸_URLì„_ë„£ìœ¼ì„¸ìš”"
conn = st.connection("gsheets", type=GSheetsConnection)

def get_data():
    try:
        return conn.read(spreadsheet=SHEET_URL, ttl="0s")
    except:
        return pd.DataFrame(columns=["ë‚ ì§œ", "ì´ë¦„", "ì—°ë½ì²˜", "ì°¸ì„ì—¬ë¶€", "ë’·í’€ì´"])

# --- 3. ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ---
if 'step' not in st.session_state:
    st.session_state.step = "input"
if 'user_info' not in st.session_state:
    st.session_state.user_info = {}

# --- 4. ë©”ì¸ í™”ë©´ ---
st.title("ğŸŠ í•œí™”ì´ê¸€ìŠ¤ ë‹¨ê´€ ëª¨ì§‘")

tab1, tab2, tab3 = st.tabs(["íˆ¬í‘œí•˜ê¸°", "ì°¸ì„ í˜„í™©", "ê´€ë¦¬ì"])

# --- Tab 1: íˆ¬í‘œí•˜ê¸° ---
with tab1:
    if st.session_state.step == "input":
        st.subheader("ì •ë³´ ì…ë ¥")
        
        # "+1" ë™ë°˜ì¸ ì²´í¬ë°•ìŠ¤ (ì…ë ¥ë€ ìƒë‹¨ ë°°ì¹˜)
        plus_one = st.checkbox("+1 (ë™ë°˜ì¸ì´ í•œ ëª… ë” ìˆë‚˜ìš”?)")
        
        name = st.text_input("ì´ë¦„")
        phone = st.text_input("ì—°ë½ì²˜ (010-0000-0000)")
        
        if st.button("íˆ¬í‘œ ì‹œì‘"):
            if name and phone:
                st.session_state.user_info = {
                    "ì´ë¦„": name, 
                    "ì—°ë½ì²˜": phone, 
                    "plus_one": plus_one
                }
                st.session_state.step = "step1"
                st.rerun()
            else:
                st.error("ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

    elif st.session_state.step == "step1":
        st.subheader(f"ğŸ™‹â€â™‚ï¸ {st.session_state.user_info['ì´ë¦„']}ë‹˜, ì°¸ì„í•˜ì‹œë‚˜ìš”?")
        col1, col2 = st.columns(2)
        with col1:
            if st.button("ğŸ§¡ ë‹¨ê´€ì°¸ì„"):
                st.session_state.user_info['ì°¸ì„'] = "ë‹¨ê´€ì°¸ì„"
                st.session_state.step = "step2"
                st.rerun()
        with col2:
            st.button("ë¯¸ì°¸ì„ (ë¹„í™œì„±)", disabled=True)

    elif st.session_state.step == "step2":
        st.subheader("ğŸ» ë’·í’€ì´ ì°¸ì„ ì—¬ë¶€")
        col1, col2 = st.columns(2)
        with col1:
            if st.button("ë’·í’€ì´ ì°¸ì„"):
                st.session_state.user_info['ë’·í’€ì´'] = "ì°¸ì„"
                st.session_state.step = "confirm"
                st.rerun()
        with col2:
            if st.button("ë’·í’€ì´ ë¯¸ì°¸ì„"):
                st.session_state.user_info['ë’·í’€ì´'] = "ë¯¸ì°¸ì„"
                st.session_state.step = "confirm"
                st.rerun()

    elif st.session_state.step == "confirm":
        msg = f"ë³¸ì¸: {st.session_state.user_info['ì°¸ì„']} / {st.session_state.user_info['ë’·í’€ì´']}"
        if st.session_state.user_info['plus_one']:
            msg += " (ë™ë°˜ì¸ +1 í¬í•¨)"
        
        st.warning(f"ìµœì¢… í™•ì¸: {msg}")
        
        if st.button("í™•ì¸ ì™„ë£Œ (ì œì¶œ)"):
            existing_data = get_data()
            now_str = datetime.now().strftime("%Y-%m-%d %H:%M")
            
            # 1. ë³¸ì¸ ë°ì´í„° ìƒì„±
            new_rows = [{
                "ë‚ ì§œ": now_str,
                "ì´ë¦„": st.session_state.user_info['ì´ë¦„'],
                "ì—°ë½ì²˜": st.session_state.user_info['ì—°ë½ì²˜'],
                "ì°¸ì„ì—¬ë¶€": st.session_state.user_info['ì°¸ì„'],
                "ë’·í’€ì´": st.session_state.user_info['ë’·í’€ì´']
            }]
            
            # 2. +1 ì²´í¬ ì‹œ ë™ë°˜ì¸ ë°ì´í„° ì¶”ê°€ (ë°”ë¡œ ì•„ë«ì¤„ìš©)
            if st.session_state.user_info['plus_one']:
                new_rows.append({
                    "ë‚ ì§œ": now_str,
                    "ì´ë¦„": "+1",
                    "ì—°ë½ì²˜": "-", # ë™ë°˜ì¸ì€ ì—°ë½ì²˜ ì œì™¸
                    "ì°¸ì„ì—¬ë¶€": st.session_state.user_info['ì°¸ì„'],
                    "ë’·í’€ì´": st.session_state.user_info['ë’·í’€ì´']
                })
            
            updated_df = pd.concat([existing_data, pd.DataFrame(new_rows)], ignore_index=True)
            conn.update(spreadsheet=SHEET_URL, data=updated_df)
            
            st.session_state.step = "done"
            st.rerun()

    elif st.session_state.step == "done":
        st.success("íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ§¡")
        if st.button("íˆ¬í‘œì™„ë£Œ (í´ë¦­ ì‹œ ì¬íˆ¬í‘œ)"):
            # ì¬íˆ¬í‘œ ë¡œì§ì€ 'í™•ì¸' ì ˆì°¨ë¥¼ ê±°ì¹©ë‹ˆë‹¤.
            st.session_state.step = "re-confirm"
            st.rerun()
            
    elif st.session_state.step == "re-confirm":
        st.info("ì •ë§ ì¬íˆ¬í‘œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ë°ì´í„°ëŠ” ì‚­ì œë©ë‹ˆë‹¤.")
        col_y, col_n = st.columns(2)
        with col_y:
            if st.button("ì˜ˆ"):
                # ì—°ë½ì²˜ê°€ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°(ë³¸ì¸)ì™€ ê·¸ ë°”ë¡œ ì•„ë˜ "+1" ë°ì´í„° ì‚­ì œ ë¡œì§
                data = get_data()
                # ë³¸ì¸ ë°ì´í„° ì‚­ì œ
                data = data[data['ì—°ë½ì²˜'] != st.session_state.user_info['ì—°ë½ì²˜']]
                # ì°¸ê³ : ì •êµí•œ ì‚­ì œë¥¼ ìœ„í•´ ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” ê³ ìœ  IDë¥¼ ì“°ëŠ”ê²Œ ì¢‹ìœ¼ë‚˜, í˜„ì¬ëŠ” ì—°ë½ì²˜ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§í•©ë‹ˆë‹¤.
                conn.update(spreadsheet=SHEET_URL, data=data)
                st.session_state.step = "input"
                st.rerun()
        with col_n:
            if st.button("ì•„ë‹ˆìš”"):
                st.session_state.step = "done"
                st.rerun()

# --- Tab 2: ì°¸ì„ í˜„í™© (ì¼ë°˜ ì‚¬ìš©ììš©) ---
with tab2:
    st.header("ğŸ“Š ì‹¤ì‹œê°„ íˆ¬í‘œ í˜„í™©")
    data = get_data()
    if not data.empty:
        total_count = len(data) # "+1" í¬í•¨ ì „ì²´ í–‰ ê°œìˆ˜
        st.metric("ì´ ì°¸ì„ ì¸ì› (ë™ë°˜ì¸ í¬í•¨)", f"{total_count}ëª…")
        # ì¼ë°˜ ì‚¬ìš©ììš© í‘œ (ì—°ë½ì²˜ ì œì™¸)
        st.dataframe(data[["ì´ë¦„", "ì°¸ì„ì—¬ë¶€", "ë’·í’€ì´"]], use_container_width=True)
    else:
        st.write("ì•„ì§ íˆ¬í‘œìê°€ ì—†ìŠµë‹ˆë‹¤.")

# --- Tab 3: ê´€ë¦¬ì (Admin) ---
with tab3:
    pwd = st.text_input("ê´€ë¦¬ì ì•”í˜¸", type="password")
    if pwd == "eagles1234":
        st.subheader("ğŸ“‹ ì „ì²´ íˆ¬í‘œ ë°ì´í„°")
        admin_data = get_data()
        st.dataframe(admin_data) # ì—°ë½ì²˜ í¬í•¨ ì „ì²´ ë°ì´í„°
        
        csv = admin_data.to_csv(index=False).encode('utf-8-sig')
        st.download_button("ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ", data=csv, file_name="hanhwa_vote.csv")